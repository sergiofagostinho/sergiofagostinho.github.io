---
layout: post
title: Unit Testing with WebRequest/WebResponse (and beyond)
date: '2013-05-14T19:37:00.000+01:00'
author: SÃ©rgio Agostinho
tags:
- ".Net"
- ASP.NET MVC
- TDD
- FTP
- Moq
- HTTP
- Castle Windsor
- Unit Testing
- Mocking
modified_time: '2015-05-13T22:29:17.362+01:00'
thumbnail: http://2.bp.blogspot.com/-dwiSvLTImLM/UZKDz9hvw3I/AAAAAAAAFFA/n6xwb2v9AIw/s72-c/ClassDiagram.png
blogger_id: tag:blogger.com,1999:blog-6105644668642718046.post-463975821123378197
blogger_orig_url: http://sergioagostinho-dev.blogspot.com/2013/05/unit-testing-with-webrequestwebresponse.html
---

<br /><div style="text-align: justify;"><b>The problem</b><br /><br />As you work in TDD, you'll find some rough edges for Unit Testing in .NET,&nbsp;particularly&nbsp;with IO, Database and networking. If you are doing Unit Testing right, then you're interested in keeping your tests&nbsp;repeatable, isolated and fast, and you simply cannot read/write files, make SQL queries or send/receive network requests. Typically, you'll avoid this by keeping all your classes decoupled by interfaces, and&nbsp;instantiated&nbsp;them with a Dependency Injection framework (e.g. Castle Windsor), and finally mocking your dependencies in your unit tests with another framework (e.g. Moq). The challenge in .NET is that most of your IO/Database/Network classes do not offer interfaces, are sealed classes, and have static methods. Since this is not a new problem, there are several individuals who have come up with their solutions: build a wrapper library around the original implementations and expose it as interfaces. Two of such solutions are&nbsp;<a href="https://github.com/tathamoddie/System.IO.Abstractions" target="_blank">System.IO.Abstractions</a>&nbsp;and&nbsp;<a href="http://systemwrapper.codeplex.com/" target="_blank">SystemWrapper</a>.&nbsp;Unfortunately, neither of these libraries includes the&nbsp;<a href="http://msdn.microsoft.com/en-us/library/system.net.webrequest(v=vs.100).aspx" target="_blank">WebRequest</a>/WebResponse classes (nor the FtpWebRequest/FtpWebResponse, the ones I actually needed), so I had to come up with a wrapper of my own. Since I can't share my employer's proprietary&nbsp;code, and I think this can be&nbsp;useful&nbsp;to others (or myself in the future), I decided to come up with my&nbsp;<a href="https://github.com/sergiofagostinho/system.interfaces" target="_blank">open-source library at github</a>&nbsp;in my free time.</div><div style="text-align: justify;"><br /></div><b>What's available (so far)</b><br /><br /><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="http://2.bp.blogspot.com/-dwiSvLTImLM/UZKDz9hvw3I/AAAAAAAAFFA/n6xwb2v9AIw/s1600/ClassDiagram.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="http://2.bp.blogspot.com/-dwiSvLTImLM/UZKDz9hvw3I/AAAAAAAAFFA/n6xwb2v9AIw/s1600/ClassDiagram.png" /></a></td></tr><tr><td class="tr-caption" style="text-align: center;">System.Net.Interfaces class diagram</td></tr></tbody></table><br /><br /><b>Notes</b><br /><br />Although I tried to make these classes/interfaces close to the original, there a couple of notable changes:<br /><ul><li>Not all methods and properties are exposed (namely&nbsp;asynchronous&nbsp;methods). WebRequest doesn't implement&nbsp;<a href="http://msdn.microsoft.com/en-us/library/system.idisposable.aspx" target="_blank">IDisposable</a>.</li><li>Factory methods (such as WebRequest.Create) are available in an abstract factory: WebRequestFactory.</li><li>The library is built on .NET framework version 4.0. It could be built on version 2.0...</li><li>In some situations, WebRequest.GetResponse method will throw a WebException with an inner WebResponse object, instead of just returning the WebResponse object. In my opinion, this was a terrible design decision by the .NET team, but we have to live with it. I could catch that particular exception and return an IWebResponse, but I would be doing more than just wrapping...</li></ul><div><b>Todo</b><br /><br /><ul><li>Add some code samples showing how to use it</li><li>Extend it with other implementations (the <a href="http://msdn.microsoft.com/en-us/library/system.net.webclient(v=vs.100).aspx" target="_blank">WebClient</a> class is the first that comes to my mind)</li><li>Make a NuGet package</li><li>Address some of the points in the "Notes" section</li></ul></div><div>So, what do you think? Have you dealt with this kind of issues before? Do you have a different approach? Is this library useful at all?<br /><br /><b>Edit (2013-07-01</b>): Unknown to me, Microsoft already <a href="http://www.kongsli.net/nblog/2009/05/03/aspnet-35-improving-testability-with-systemwebabstractions/" target="_blank">solved this</a> a couple of years ago, through the System.Web.Abstractions namespace (included with ASP.NET MVC 3.5), and more recently (.NET 4.0 onwards), included in the System.Web namespace.</div><br /><ul></ul>