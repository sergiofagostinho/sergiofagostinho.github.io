---
layout: post
title: The entropy of logging
date: '2015-06-17T21:18:00.000+01:00'
author: Sérgio Agostinho
tags:
- Java
- ".Net"
- Domain Driven Design
- logging
- micro-services
modified_time: '2015-06-18T09:12:35.877+01:00'
thumbnail: http://1.bp.blogspot.com/-cQepPW4hZZU/VWcGKGwzeFI/AAAAAAAAJ24/tV8Xpb1W3tk/s72-c/levels.png
blogger_id: tag:blogger.com,1999:blog-6105644668642718046.post-173614674644537161
blogger_orig_url: http://sergioagostinho-dev.blogspot.com/2015/05/the-entropy-of-logging.html
---

<em>A couple of weeks ago, my colleague António Vieira made an internal presentation called the “The entropy of logging”. In this post I share the main points of the presentation and my thoughts on the subject.</em><br /><br /><h3>Logging</h3><div><blockquote class="tr_bq"><i>"Event logs record events taking place in the execution of a system in order to provide an audit trail that can be used to understand the activity of the system and to diagnose problems. They are essential to understand the activities of complex systems,&nbsp;particularly&nbsp;in the case&nbsp;of applications with little user interaction (such as server applications)." - <a href="http://en.wikipedia.org/wiki/Logfile#Event_logs" target="_blank">Wikipedia</a></i></blockquote><blockquote class="tr_bq">We all know what logging is but how to do it right?</blockquote><blockquote class="tr_bq">&nbsp;Some guidelines might help…</blockquote><h3>&nbsp;Relevant</h3><blockquote class="tr_bq"><i>Captain's Log, Stardate 43125.8. We have entered a spectacular binary star system in the Kavis Alpha sector on a most critical mission of astrophysical research. Our eminent guest, Dr. Paul Stubbs, will attempt to study the decay of neutronium expelled at relativistic speeds from a massive stellar explosion which will occur here in a matter of hours.</i></blockquote></div><h3>Irrelevant</h3><blockquote class="tr_bq"><i>Captain's Log, Stardate 43125.8. Today I had baked beans for lunch. Lt Commander Data didn’t understand my irony. Lt Commander La Forge has the feeling unwell, probably the galactic flu.</i></blockquote><div><h3>Levels</h3><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-cQepPW4hZZU/VWcGKGwzeFI/AAAAAAAAJ24/tV8Xpb1W3tk/s1600/levels.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="233" src="http://1.bp.blogspot.com/-cQepPW4hZZU/VWcGKGwzeFI/AAAAAAAAJ24/tV8Xpb1W3tk/s640/levels.png" width="640" /></a></div><div><br /></div><h3>7 guidelines</h3><blockquote class="tr_bq"><ol><li>Log <i>relevant</i> events</li><li>Log the&nbsp;<i>unpredictable</i></li><li><i>1</i> event = <i>1</i> log line</li><li>Log the <i>boundaries</i> of the application</li><li>Consistent and <i>parsable</i></li><li>End-to-end <i>traceability</i></li><li>Protect <i>privacy</i></li></ol></blockquote></div><br /><div><h3>Should libraries include logging?</h3><blockquote class="tr_bq">No! Logging is an application level concern<br />Libraries should expose all the relevant state as return values, exceptions or event listeners.<br />If you really need events on your library keep it very simple and plugable.</blockquote><div><br /></div><h3>My (Sergio) conclusion</h3><div style="text-align: justify;">Logging is something that many of us, professional developers, take for granted. In every project I've worked, as soon as deploy an application to an environment, things start to fail (which is expected), but it’s rare that the existing log is enough to quickly debug the problem. Most often, critical information is missing, and the existing log entries are mostly just clutter.</div><br /><div style="text-align: justify;">Based on my experience, all of these guidelines are valid. The ones I hadn't applied in the past were point 3, as well as point 5 and 7, but simply because they didn't apply to my application's domain.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Having one log entry per event may seem strange at first because it seems a strong constrain, but I've recently have been applying it, and it has actually made the code cleaner. Basically, each domain event will produce a single log entry in case of success (INFO), or in the case of failure (ERROR)To me it feels the correct approach, particularly for a <i>Domain Driven Design</i> approach (although I haven't been using it currently), as you should have one log entry per domain event. Having that said, this shouldn't be applied <i>too</i> literally: it's still OK to have a random log entry at the DEBUG level, just not at INFO and ERROR (you are filtering DEBUG entries in production, right? :))</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">By applying the single log entry guideline, you'll probably have to log a <i>lot</i> of information, which leads to the <i>parsable</i> guideline. In our current development, we've found that the best approach is to log it as JSON. We are not constraining the event to an actual schema, although we try to be consistent. In practise, this means we are using <a href="http://www.newtonsoft.com/json">Json.NET</a> to serialize a <a href="https://msdn.microsoft.com/en-us/library/dd264741.aspx" target="_blank">dynamic</a> object (in .NET), or <a href="https://github.com/FasterXML/jackson">Jackson</a> to serialize an <a href="http://docs.oracle.com/javase/7/docs/api/java/util/HashMap.html" target="_blank">HashMap</a> object. Log parsing tools (such as <a href="http://logstash.net/" target="_blank">logstash</a>) should have any problem with this.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Regarding privacy, we have been very careful. We try to use <a href="https://msdn.microsoft.com/en-us/library/system.security.securestring(v=vs.110).aspx" target="_blank">SecureString</a> (in .NET) or <a href="http://stackoverflow.com/questions/8881291/why-is-char-preferred-over-string-for-passwords" target="_blank">char[]</a> (in Java) types for holding passwords in memory, but for the remaining data the best approach is to remove sensitive fields from serialization (preferably in a declaratively form, to be clear about this in the code). When the sensitive information <i>is relevant </i>for logging issues, the standard approach is to log the first N characters of the text, and add place-holders (such as the asterisk character) to the remaining text.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Finally, regarding on the point of not logging on libraries, I can't say I totally agree with António. I mean, I agree if the library is a thin layer, such as in an <i>infrastructure</i>&nbsp;layer library; but this may harder to implement if the library is complex, such as a <i>domain</i>&nbsp;layer library (as I have implemented in the past). What I can add is that we should avoid logging in libraries if we possible; if not,we should use a logging framework facade, such as <a href="http://netcommon.sourceforge.net/" target="_blank">CommonLogging</a> in .NET or <a href="http://www.slf4j.org/" target="_blank">SLF4J</a> in Java, to reduce the change of friction.</div><br /><i>Thanks to <a href="https://pt.linkedin.com/in/tozevv">António Vieira</a> for the interesting discussion and allowing me to share some of the content of his presentation.</i></div>